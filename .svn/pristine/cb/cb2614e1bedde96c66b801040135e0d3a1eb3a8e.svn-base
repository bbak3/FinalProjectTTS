import React, { useEffect, useState } from 'react'
import * as API from '../../../api/accountApi';

/**
 * AccountExcelModal.jsx
 * 
 * ì‘ì„±ì : ê¹€ê²½í¬
 * ì—­í•  : ì—‘ì…€ íŒŒì¼ ë‹´ë‹¹
 * 
 * ì¢…ë¥˜
 * 1) ì—‘ì…€ ì¼ê´„ ë“±ë¡
 * 2) ì—‘ì…€ ì¼ê´„ ë‹¤ìš´ë¡œë“œ
 */
// ì§ì±… í•„í„° í•œê¸€ ë³€í™˜
const POSITION_MAP = {
    "": "ì „ì²´",
    "0": "ê´€ë¦¬ì",
    "1": "ì˜ì‚¬",
    "2": "ì™¸ë˜ê°„í˜¸ì‚¬", 
    "3": "ì…ì›ê°„í˜¸ì‚¬",
    "4": "ì•½ì‚¬",
    "5": "ë°©ì‚¬ì„ ì‚¬",
    "6": "ë¬¼ë¦¬ì¹˜ë£Œì‚¬",
    "7": "ì›ë¬´ê³¼"
};

// ì •ë ¬ í•„í„° í•œê¸€ ë³€í™˜
const SORT_MAP = {
    "": "ì „ì²´ (í‡´ì‚¬ì í¬í•¨)",
    "active": "ì¬ì§ìë§Œ",
    "retired": "í‡´ì‚¬ìë§Œ",
    "date_desc": "ì…ì‚¬ì¼ ìµœì‹ ìˆœ",
    "date_asc": "ì…ì‚¬ì¼ ê³¼ê±°ìˆœ"
};

function AccountExcelModal({ isOpen, onClose, onSuccess, filters, setFilters, mode}) {

    // ì—‘ì…€ íŒŒì¼ ìƒíƒœ
    const [excelFile, setExcelFile] = useState(null);

    // ì—‘ì…€ íŒŒì¼ ì—…ë¡œë“œ ìƒíƒœ
    const [isLoading, setIsLoading] = useState(false);

    // ëª¨ë‹¬ ì—´ë•Œë§ˆë‹¤ ì´ˆê¸°í™” í›…
    useEffect(() => {
        if (isOpen) setExcelFile(null);
    }, [isOpen]);
    
    // ëª¨ë“œì— ë§ëŠ” ì œëª© ë³´ì—¬ì£¼ê¸°
    const title = mode === 'upload' ? "ì—‘ì…€ ì¼ê´„ ê³„ì • ë“±ë¡" : "ì—‘ì…€ ì¼ê´„ ë‹¤ìš´ë¡œë“œ";
    
    // ì—‘ì…€ íŒŒì¼ ì„ íƒ
    const handleExcelChange = (e) => {
        const file = e.target.files[0];
        if (file) setExcelFile(file);
    };

    // ë“œë˜ê·¸ ì•¤ ë“œë¡­ í•¸ë“¤ëŸ¬
    const handleDragOver = (e) => {
        e.preventDefault();
    };

    // í•¸ë“¤ ë“œë¡­..
    const handleDrop = (e) => {
        e.preventDefault();

        const file = e.dataTransfer.files[0];
        
        // í™•ì¥ìê°€ ì—‘ì…€ íŒŒì¼ì¼ë•Œë§Œ ê°€ëŠ¥
        if (file && (file.name.endsWith('.xlsx') || file.name.endsWith('.xls'))) {
            setExcelFile(file);
        } else {
            alert(".xlsx í˜¹ì€ .xls ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
        }
    };

    // ì—‘ì…€ ì¼ê´„ ë“±ë¡
    const handleExcelUpload = async () => {
        if (!excelFile) return alert("ì—‘ì…€ íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");

        try {
            setIsLoading(true); // ë¡œë”© ì‹œì‘
            
            // FormData ìƒì„±
            const formData = new FormData();
            formData.append("file", excelFile);

            const response = await API.uploadExcel(formData);

            const { successCount, failCount, failDetails } = response.data;

            // ê²°ê³¼ ì²˜ë¦¬
            if (failCount === 0) {
                // 100% ì„±ê³µ ì‹œ
                alert(`ì´ ${successCount}ëª… ì •ìƒì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ‰`);
                setExcelFile(null);
                onClose?.();   // ëª¨ë‹¬ ë‹«ê¸°
                onSuccess?.(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
            } else {
                // ë¶€ë¶„ ì‹¤íŒ¨ ë˜ëŠ” ì „ì²´ ì‹¤íŒ¨ ì‹œ
                let msg = `[ì²˜ë¦¬ ê²°ê³¼]\nâœ… ì„±ê³µ: ${successCount}ê±´\nâŒ ì‹¤íŒ¨: ${failCount}ê±´\n\n[ì‹¤íŒ¨ ì‚¬ìœ ]\n`;
                
                // ì‹¤íŒ¨ ë¦¬ìŠ¤íŠ¸ë¥¼ ëŒë©° ë©”ì‹œì§€ ìƒì„± (ìµœëŒ€ 10ê°œê¹Œì§€!!)
                failDetails.slice(0, 10).forEach((detail) => {
                    msg += `- ${detail.row}í–‰: ${detail.reason}\n`;
                });
                
                if (failDetails.length > 10) {
                    msg += `...ì™¸ ${failDetails.length - 10}ê±´`;
                }

                // ì‚¬ìš©ìì—ê²Œ ë„ìš¸ ë©”ì„¸ì§€
                alert(msg);
                
                // ì‹¤íŒ¨ê°€ ìˆì–´ë„ ì„±ê³µí•œ ê±´ì€ DBì— ë“¤ì–´ê°”ìœ¼ë‹ˆ ëª©ë¡ ê°±ì‹ 
                setExcelFile(null);
                onClose?.();
                onSuccess?.(); 
            }
        } catch (error) {
            console.error("ì—…ë¡œë“œ ì—ëŸ¬:", error);
            const errData = error.response?.data;

            const errorMsg = errData?.message || errData?.msg || errData?.error || "ì„œë²„ì™€ í†µì‹  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
            alert(`ì¼ê´„ ë“±ë¡ ì‹¤íŒ¨: ${errorMsg}`);

        } finally {
            setIsLoading(false);
        }
    };

    // ì—‘ì…€ ë‹¤ìš´ë¡œë“œ 
    const handleExcelDownload = async () => {
        try {
            setIsLoading(true);
            // api í˜¸ì¶œí•´ì„œ ë¶€ëª¨ì—ê²Œ ë°›ì€ filtersë¥¼ ì‚¬ìš©
            const res = await API.downloadExcel(filters);
            const blob = res.data;
            
            // ì„œë²„ì—ì„œ ì—‘ì…€ ëŒ€ì‹  JSON(ì—ëŸ¬ë©”ì‹œì§€)ì„ ë³´ëƒˆëŠ”ì§€ í™•ì¸
            if (blob.type.includes('application/json')) {
                const text = await blob.text();
                const json = JSON.parse(text);
                throw new Error(json.message || "ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨");
            }

            // --- ì •ìƒ ë‹¤ìš´ë¡œë“œ ë¡œì§ ì‹œì‘ ---

            // íŒŒì¼ëª… ì„¸íŒ…
            let filename = `ì§ì›ê³„ì •ëª©ë¡_${new Date().toISOString().slice(0, 10)}.xlsx`;
            
            // í—¤ë”ì—ì„œ íŒŒì¼ëª… ì¶”ì¶œ ì‹œë„
            const disposition = res.headers['content-disposition'];
            if (disposition) {
                const decodedFileName = decodeURIComponent(disposition);
                const matches = decodedFileName.match(/filename\*?=['"]?(?:UTF-\d['"]*)?([^;\r\n"']*)['"]?;?/);
                if (matches && matches[1]) {
                    filename = matches[1].replace(/['"]/g, ''); // ë”°ì˜´í‘œ ì œê±°
                }
            }

            // ë¸Œë¼ìš°ì € ë‹¤ìš´ë¡œë“œ ì‹¤í–‰
            const url = window.URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.href = url;
            link.setAttribute("download", filename);
            document.body.appendChild(link);
            link.click();
            
            // ë’·ì •ë¦¬
            link.remove();
            window.URL.revokeObjectURL(url);

            // ëª¨ë‹¬ ë‹«ê¸°
            onClose?.();

        } catch (error) {
            // âœ… ì—ëŸ¬ ë°œìƒ ì‹œ ì—¬ê¸°ì„œ ëª¨ë‘ ì²˜ë¦¬
            console.error(error);
            const msg = error.message || "ë‹¤ìš´ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
            alert(msg);
        } finally {
            setIsLoading(false);
        }
    };

    // isOpenì´ falseë©´ ì•„ë¬´ê²ƒë„ ë Œë”ë§ ì•ˆ í•¨ (ì—ëŸ¬ ë°©ì§€ìš© ì•ˆì „ì¥ì¹˜)
    if (!isOpen) return null;

    return (
        <>
            <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm">
                <div className="bg-white w-[600px] max-h-[90vh] rounded-[2rem] shadow-2xl overflow-hidden flex flex-col animate-in fade-in zoom-in duration-200">

                    {/* ëª¨ë‹¬ ì°½ ë‹«ê¸° ë²„íŠ¼ */}
                    <div className="p-6 border-b border-slate-100 flex justify-between items-center bg-white shrink-0">
                        <h3 className="text-lg font-bold text-slate-900">{title}</h3>
                        <button onClick={() => {setExcelFile(null); onClose?.();}} type="button" className="w-8 h-8 flex items-center justify-center rounded-full hover:bg-slate-100 text-slate-400">
                            âœ•
                        </button>
                    </div>

                    <div className="flex-1 py-8 px-12 overflow-y-auto custom-scrollbar">
                        {/* ë‹¤ìš´ë¡œë“œ ëª¨ë“œ */}
                        {mode === 'download' && (
                            <div className="flex flex-col gap-6">
                                <div className="text-center">
                                    <span className="text-5xl mb-4 block">ğŸ“Š</span>
                                    <h4 className="text-lg font-bold text-slate-800 mb-2">ê²€ìƒ‰ëœ ê²°ê³¼ë¥¼ ë‹¤ìš´ë¡œë“œí• ê¹Œìš”?</h4>
                                    <p className="text-xs text-slate-400">í˜„ì¬ ì ìš©ëœ í•„í„° ì¡°ê±´ì€ ì•„ë˜ì™€ ê°™ìŠµë‹ˆë‹¤.</p>
                                </div>

                                {/* í˜„ì¬ ì„¤ì •ëœ í•„í„° */}
                                <div className="bg-slate-50 rounded-2xl p-5 border border-slate-100 flex flex-col gap-4">
                                
                                {/* 1. ì§ì±… ì„ íƒ */}
                                <div className="flex flex-col gap-1">
                                    <label className="text-xs font-bold text-slate-500 ml-1">ì§ì±… í•„í„°</label>
                                    <select value={filters.position} onChange={(e) => setFilters({...filters, position: e.target.value})}
                                        className="w-full p-3 bg-white border border-slate-200 rounded-xl text-sm font-bold text-slate-700 outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-100 transition-all cursor-pointer">
                                        {/* âœ… Mapì„ ëŒë©´ì„œ ìë™ ìƒì„± */}
                                        {Object.entries(POSITION_MAP).map(([key, label]) => (
                                            <option key={key} value={key}>
                                                {label}
                                            </option>
                                        ))}
                                    </select>
                                </div>

                                {/* ì •ë ¬ í•„í„° */}
                                <div className="flex flex-col gap-1">
                                    <label className="text-xs font-bold text-slate-500 ml-1">ì¬ì§ ìƒíƒœ</label>
                                    <select value={filters.sort} onChange={(e) => setFilters({...filters, sort: e.target.value})}
                                        className="w-full p-3 bg-white border border-slate-200 rounded-xl text-sm font-bold text-slate-700 outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-100 transition-all cursor-pointer">
                                        <option value="">ì „ì²´ (í‡´ì‚¬ì í¬í•¨) ì¶œë ¥</option>
                                        <option value="active">ì¬ì§ìë§Œ ì¶œë ¥</option>
                                        <option value="retired">í‡´ì‚¬ìë§Œ ì¶œë ¥</option>
                                        <option value="date_desc">ì…ì‚¬ì¼ ìµœì‹ ìˆœìœ¼ë¡œ ì¶œë ¥</option>
                                        <option value="date_asc">ì…ì‚¬ì¼ ê³¼ê±°ìˆœìœ¼ë¡œ ì¶œë ¥</option>
                                    </select>
                                </div>
                            </div>

                                <button type="button" onClick={handleExcelDownload} disabled={isLoading}
                                        className="w-full py-4 bg-blue-600 text-white rounded-2xl font-bold shadow-lg shadow-blue-200 hover:bg-blue-700 transition-all">
                                    {isLoading ? "ë‹¤ìš´ë¡œë“œ ì¤‘..." : "ì—‘ì…€ íŒŒì¼ ë‹¤ìš´ë¡œë“œ"}
                                </button>
                            </div>
                        )}

                        {/* ì—…ë¡œë“œ ëª¨ë“œ */}
                        {mode === 'upload' && (
                            <div>
                                {/* ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì˜ì—­ */}
                                <div onDragOver={handleDragOver} onDrop={handleDrop}
                                    className={`border-2 border-dashed rounded-2xl p-10 flex flex-col items-center justify-center bg-slate-50 mb-6 relative transition-colors
                                    ${excelFile ? 'border-emerald-500 bg-emerald-50' : 'border-slate-200 hover:border-emerald-400' }`}>
                                    <input type="file" accept=".xlsx, .xls" className="absolute inset-0 opacity-0 cursor-pointer" onChange={handleExcelChange} />
                                    <span className="text-4xl mb-4">{excelFile ? 'ğŸ“‚' : 'ğŸ“„'}</span>
                                    <p className="text-sm font-bold text-slate-600">
                                        {excelFile ? <span className="text-emerald-600">{excelFile.name}</span> : "ì—‘ì…€ íŒŒì¼ì„ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì„¸ìš”"}
                                    </p>
                                </div>

                                {/* ë²„íŠ¼ ì˜ì—­ */}
                                <div className="flex gap-3">
                                    <button type="button" disabled={isLoading} onClick={() => {setExcelFile(null); onClose?.(); }}
                                            className="flex-1 py-4 rounded-2xl bg-white border border-slate-200 text-sm font-bold text-slate-500 hover:bg-slate-100">
                                        ì·¨ì†Œ
                                    </button>
                                    <button type="button" disabled={isLoading || !excelFile} onClick={handleExcelUpload}
                                            className="flex-[2] py-4 rounded-2xl bg-emerald-600 text-white text-sm font-black shadow-lg shadow-emerald-100 hover:bg-emerald-700 disabled:opacity-60 transition-all">
                                        {isLoading ? "ì—…ë¡œë“œ ì¤‘..." : "ì¼ê´„ ë“±ë¡ í™•ì •"}
                                    </button>
                                </div>
                            </div>
                        )}

                    
                    </div>


                </div>
            </div>
        </>
    );
}

export default AccountExcelModal;