import axios from "../../../api/axios";
import { useCallback, useEffect, useRef, useState } from "react"

/** 
    웹소켓 연결 및 알림 데이터 관리
*/

// 쿠키 이름으로 값을 찾아주는 함수
const getCookie = (name) => {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
};

export const useNotification = () => {
    const [notifications, setNotifications] = useState([]); // 알림 목록
    const [unreadCount, setUnreadCount] = useState(0); // 안 읽은 개수
    const socketRef = useRef(null); // 소켓 담아둘 박스 생성

    // 알림 목록 불러오기(alarmLoadList 역할)
    const fetchNotifications = useCallback(async () => {
        try{
            const response = await axios.get('/notification/list');
            setNotifications(response.data || []);
            setUnreadCount(response.data.length);
        }catch(error){
            console.error("알림 로드 실패 : ", error);
        }
    }, []);

    // 개별 읽기(alarmReadOne 역할)
    const readOne = async (alertNo) => {
        try{
            await axios.post(`http://localhost:8060/notification/read?alertNo=${alertNo}`);
            fetchNotifications(); // 목록 갱신
        }catch(error){
            console.error("읽기 실패 : ", error);
        }
    };

    // 모두 읽기(alarmReadAll 역할)
    const readAll = async () => {
        try{
            await axios.post('http://localhost:8060/notification/readAll');
            fetchNotifications(); // 목록 갱신
        }catch(error){
            console.error("전체 읽기 실패 : ", error);
        }
    };

    // 웹소켓 연결(connectNotificationsWs 역할)
    useEffect(() => {
        // 쿠키에서 토큰 가져오기 및 웹소켓 URL에 포함
        const token = getCookie("ACCESS_TOKEN");

        if (!token) return;

        // 이미 연결되었거나 연결 중이면 중단
        if (socketRef.current && (socketRef.current.readyState === 0 || socketRef.current.readyState === 1)) {
            return;
        }

        // 리액트에서 sts로 접속
        const wsUri = `ws://localhost:8060/ws/alarm?token=${token}`;
        const socket = new WebSocket(wsUri);
        socketRef.current = socket;

        // 연결 성공 시
        socket.onopen = () => console.log("알림 웹소켓 연결 성공");

        // 서버로부터 알림 받았을 때
        socket.onmessage = (event) => {
            console.log("새 알림 수신 : ", event.data);
            if(event.data === "NEW_ALARM"){
                fetchNotifications(); // 새 알림 오면 목록 갱신
            }
        };

        // 연결 종료 시
        socket.onclose = () => {
            console.log("알림 웹소켓 연결 종료");
            socketRef.current = null; // 종료 시 박스 비우기
        }

        // 에러 발생 시
        socket.onerror = (err) => console.log("알림 웹소켓 에러 : ", err);

        fetchNotifications(); // 첫 로드 시 실행

        return () => {
           // 컴포넌트가 재렌더링되거나 언마운트될 때 무조건 기존 소켓을 닫음
            if (socketRef.current) {
                console.log("이전 세션 정리 중...");
                socketRef.current.close();
                socketRef.current = null;
            } 
        }

    }, []);

    return {notifications, unreadCount, fetchNotifications, readOne, readAll};
};