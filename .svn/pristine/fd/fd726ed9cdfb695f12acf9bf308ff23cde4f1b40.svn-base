import React, { useState, useEffect, useCallback } from 'react';
import { useNavigate } from 'react-router-dom';
import axios from 'axios';
import Swal from 'sweetalert2';

// --- 라이브러리 ---
import FullCalendar from '@fullcalendar/react';
import dayGridPlugin from '@fullcalendar/daygrid';
import timeGridPlugin from '@fullcalendar/timegrid';
import interactionPlugin from '@fullcalendar/interaction';
import { ChevronDown, CheckCircle } from 'lucide-react';

// --- 컴포넌트 ---
import Header from "../../components/layout/Header.jsx";
import LeftAdmin from "../../components/layout/LeftAdmin.jsx";
import EventModal from "../../features/calendar/EventModal";

// --- 상수 및 설정 ---
const HOSPITAL_COMMON_ID = '26020908'; // 병원 공통 일정용 ID
const API_BASE_URL = 'http://localhost:8060/api/calendar';

// --- 유틸리티 함수 ---
const normalizeDate = (dateStr, isEnd = false) => {
  if (!dateStr) return null;
  // 'YYYY-MM-DD' 형식일 경우 시간을 강제로 붙여줌 (FullCalendar 호환성)
  if (!dateStr.includes('T')) {
    return isEnd ? `${dateStr}T18:00` : `${dateStr}T09:00`;
  }
  return dateStr;
};

// =============================================================================
// 캘린더 전용 메뉴 사이드바
// =============================================================================
const MenuSidebar = ({ viewType, setViewType, selectedDoctorId, setSelectedDoctorId, doctorList }) => (
  <div className="content-area flex flex-col w-[240px] bg-white rounded-lg shadow-sm border border-gray-200 p-4 shrink-0 hidden md:flex h-full">
    <div className="mb-4">
      <div style={{ fontSize: 'var(--font-lg)', fontWeight: 'var(--font-medium)' }}>
        일정 관리 메뉴
      </div>
    </div>
    <hr className="mb-4 border-gray-200" />

    <div className="space-y-2">
      {/* 병원 공통 일정 버튼 */}
      <button
        onClick={() => setViewType('COMMON')}
        className={`w-full text-left px-4 py-3 rounded-lg font-bold text-[13px] flex justify-between items-center transition-all ${
          viewType === 'COMMON' ? 'bg-blue-50 text-blue-600' : 'text-slate-500 hover:bg-gray-50'
        }`}
      >
        병원 공통 일정 {viewType === 'COMMON' && <CheckCircle size={14} />}
      </button>

      {/* 의사별 개인 일정 영역 */}
      <div className={`rounded-lg transition-all ${viewType === 'PERSONAL' ? 'bg-blue-50/50 border border-blue-100' : ''}`}>
        <button
          onClick={() => setViewType('PERSONAL')}
          className={`w-full text-left px-4 py-3 rounded-lg font-bold text-[13px] flex justify-between items-center transition-all ${
            viewType === 'PERSONAL' ? 'text-blue-600' : 'text-slate-500 hover:bg-gray-50'
          }`}
        >
          의사별 개인 일정 {viewType === 'PERSONAL' && <CheckCircle size={14} />}
        </button>

        {/* 개인 일정 선택 시, 드롭다운 메뉴 표시 */}
        {viewType === 'PERSONAL' && (
          <div className="px-4 pb-3 animate-fadeIn">
            <div className="relative">
              <select
                value={selectedDoctorId}
                onChange={(e) => setSelectedDoctorId(Number(e.target.value))}
                className="w-full p-2.5 pl-3 pr-8 text-xs font-bold text-slate-700 bg-white border border-blue-200 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 appearance-none cursor-pointer shadow-sm"
              >
                {(!Array.isArray(doctorList) || doctorList.length === 0) ? (
                  <option value="0">목록 없음</option>
                ) : (
                  doctorList.map((doc) => (
                    <option key={doc.employeeNo} value={doc.employeeNo}>{doc.empName}</option>
                  ))
                )}
              </select>
              <ChevronDown className="absolute right-2.5 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none" size={14} />
            </div>
          </div>
        )}
      </div>
    </div>
  </div>
);


// =============================================================================
// [메인 컴포넌트] 의사 캘린더 페이지
// =============================================================================
function DoctorCalendarPage() {
  const navigate = useNavigate();

  // --- 상태 관리: 뷰 모드 및 필터 ---
  const [viewType, setViewType] = useState('COMMON'); // 'COMMON'(공통) or 'PERSONAL'(개인)
  const [selectedDoctorId, setSelectedDoctorId] = useState(0);

  // --- 상태 관리: 데이터 (일정 및 의사 목록) ---
  const [events, setEvents] = useState([]);
  const [doctorList, setDoctorList] = useState([]);

  // --- 상태 관리: 모달 및 선택된 항목 ---
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [selectedEvent, setSelectedEvent] = useState(null);
  const [selectedDateRange, setSelectedDateRange] = useState(null);

  // ===========================================================================
  // 1. 데이터 조회 (API 연동)
  // ===========================================================================

  // (1) 의사 목록 조회
  useEffect(() => {
    const fetchDoctors = async () => {
      try {
        const res = await axios.get(`${API_BASE_URL}/doctors`);
        if (Array.isArray(res.data)) {
          setDoctorList(res.data);
          // 목록이 있으면 첫 번째 의사를 기본값으로 설정
          if (res.data.length > 0) setSelectedDoctorId(res.data[0].employeeNo);
        } else {
          setDoctorList([]);
        }
      } catch (err) {
        console.error("의사 목록 로딩 실패:", err);
        setDoctorList([]);
      }
    };
    fetchDoctors();
  }, []);

  // (2) 일정 데이터 조회 (뷰 타입이나 선택된 의사가 변경될 때마다 재호출)
  const fetchEvents = useCallback(async () => {
    try {
      const empNoParam = viewType === 'COMMON' ? 0 : selectedDoctorId;
      // 개인 일정 보기인데 선택된 의사가 없으면 조회하지 않음
      if (viewType === 'PERSONAL' && empNoParam === 0) return;

      const response = await axios.get(`${API_BASE_URL}/list`, {
        params: { employeeNo: empNoParam }
      });

      console.log("일정 로딩 성공:", response.data);

      const dataList = Array.isArray(response.data) ? response.data : [];
      
      // FullCalendar 형식에 맞게 DB 데이터를 변환
      const mappedEvents = dataList.map(item => ({
        id: String(item.scheduleNo),
        title: item.title,
        start: item.start,
        end: item.end,
        allDay: item.allDay === 1 || (item.start && !item.start.includes('T')),
        backgroundColor: item.backgroundColor,
        borderColor: item.backgroundColor,
        textColor: '#334155',
        extendedProps: { // 캘린더 API 외에 추가로 필요한 데이터들
          scheduleNo: item.scheduleNo,
          type: item.type,
          employeeNo: item.employeeNo,
          description: item.description,
          scheduleDoctorNo: item.scheduleDoctorNo
        }
      }));
      setEvents(mappedEvents);
    } catch (error) {
      console.error("일정 로딩 실패:", error);
      setEvents([]);
    }
  }, [viewType, selectedDoctorId]);

  useEffect(() => { fetchEvents(); }, [fetchEvents]);

  // ===========================================================================
  // 2. 이벤트 핸들러 (생성/수정/삭제)
  // ===========================================================================

  // 일정 저장 (추가 및 수정)
  const handleSaveEvent = async (formData) => {
    const selectedEmpNo = Number(formData.employeeNo);

    const eventData = {
      scheduleNo: selectedEvent ? selectedEvent.extendedProps.scheduleNo : 0,
      title: formData.title,
      description: formData.description,
      start: normalizeDate(formData.start),
      end: normalizeDate(formData.end, true),
      type: '001', // 기본 타입 설정 (필요시 수정)
      employeeNo: selectedEmpNo || HOSPITAL_COMMON_ID,
      scheduleDoctorNo: selectedEmpNo,
      allDay: formData.allDay ? 1 : 0
    };

    try {
      if (selectedEvent) {
        // 일정 수정
        await axios.post(`${API_BASE_URL}/update`, eventData);
        Swal.fire('성공', '일정이 수정되었습니다.', 'success');
      } else {
        // 일정 추가
        await axios.post(`${API_BASE_URL}/add`, eventData);
        Swal.fire('성공', '새 일정이 등록되었습니다.', 'success');
      }
      fetchEvents(); // 데이터 갱신
      setIsModalOpen(false); // 모달 닫기
    } catch (error) {
      console.error("저장 실패:", error.response || error);
      Swal.fire('오류', '저장 중 오류가 발생했습니다.', 'error');
    }
  };

  // 일정 삭제
  const handleDeleteEvent = async (eventId) => {
    const result = await Swal.fire({
      title: '삭제 확인',
      text: '정말 삭제하시겠습니까?',
      icon: 'warning',
      showCancelButton: true,
      confirmButtonText: '삭제',
      cancelButtonText: '취소'
    });

    if (result.isConfirmed) {
      try {
        await axios.post(`${API_BASE_URL}/delete/${eventId}`);
        Swal.fire('삭제됨', '일정이 삭제되었습니다.', 'success');
        fetchEvents();
        setIsModalOpen(false);
      } catch (error) {
        console.error("삭제 실패:", error);
        Swal.fire('오류', '삭제에 실패했습니다.', 'error');
      }
    }
  };

  // 일정 드래그 앤 드롭
  const handleEventDrop = async (info) => {
    const result = await Swal.fire({
      title: '일정 이동',
      text: `'${info.event.title}' 일정을 이동하시겠습니까?`,
      icon: 'question',
      showCancelButton: true,
      confirmButtonText: '이동',
      cancelButtonText: '취소'
    });

    if (!result.isConfirmed) {
      info.revert(); // 취소 시 원래 위치로 복구
      return;
    }

    let safeStart = normalizeDate(info.event.startStr);
    let safeEnd = normalizeDate(info.event.endStr || info.event.startStr, true);
    // 날짜 문자열 정리 (YYYY-MM-DDTHH:mm)
    safeStart = safeStart.slice(0, 16);
    safeEnd = safeEnd.slice(0, 16);

    const props = info.event.extendedProps;
    let safeEmployeeNo = Number(props.employeeNo);
    let safeScheduleDoctorNo = Number(props.scheduleDoctorNo || safeEmployeeNo);

    // 공통 일정 타입이거나 의사 정보가 없으면 공통 ID로 설정
    if (['병원행사', '시설점검', '기타', '001', '사내일정'].includes(props.type) || !safeEmployeeNo) {
      safeEmployeeNo = HOSPITAL_COMMON_ID;
    }

    const updatedEvent = {
      scheduleNo: props.scheduleNo,
      title: info.event.title,
      start: safeStart,
      end: safeEnd,
      type: '001',
      employeeNo: safeEmployeeNo,
      scheduleDoctorNo: safeScheduleDoctorNo,
      description: props.description,
      allDay: info.event.allDay ? 1 : 0
    };

    try {
      await axios.post(`${API_BASE_URL}/update`, updatedEvent);
      console.log("일정 이동 성공");
    } catch (error) {
      console.error("이동 실패:", error);
      Swal.fire('오류', '이동 중 오류가 발생했습니다.', 'error');
      info.revert();
    }
  };

  // ===========================================================================
  // 3. UI 상호작용 (날짜 선택, 일정 클릭)
  // ===========================================================================

  // 날짜 드래그 선택 시 (새 일정 생성)
  const handleDateSelect = (selectInfo) => {
    setSelectedEvent(null);
    setSelectedDateRange(selectInfo);
    setIsModalOpen(true);
  };

  // 기존 일정 클릭 시 (수정/삭제)
  const handleEventClick = (clickInfo) => {
    setSelectedEvent(clickInfo.event);
    setSelectedDateRange({
      startStr: clickInfo.event.startStr,
      endStr: clickInfo.event.endStr || clickInfo.event.startStr,
      allDay: clickInfo.event.allDay
    });
    setIsModalOpen(true);
  };

  // ===========================================================================
  // 4. 화면
  // ===========================================================================
  return (
    <div className="app h-screen w-full flex flex-col bg-neutral-100 text-zinc-950">
      
      {/* 모달 */}
      <EventModal
        isOpen={isModalOpen}
        onClose={() => setIsModalOpen(false)}
        onSave={handleSaveEvent}
        onDelete={handleDeleteEvent}
        initialDate={selectedDateRange}
        eventData={selectedEvent}
        currentViewType={viewType}
        currentDoctorId={selectedDoctorId}
        doctorList={doctorList}
      />

      {/* 헤더 영역 */}
      <header className="w-full h-16 bg-white border-b border-gray-200 shrink-0">
        <Header />
      </header>

      {/* 메인 컨테이너 */}
      <div className="main-container flex flex-1 overflow-hidden">
        
        {/* 관리자 메인 사이드바 */}
        <LeftAdmin />

        {/* --- 3. 메인 콘텐츠 영역 --- */}
        <main className="main-content flex-1 overflow-hidden p-4">
          <div className="flex gap-4 h-full">

            {/* 캘린더 메뉴 사이드바 */}
            <MenuSidebar
              viewType={viewType}
              setViewType={setViewType}
              selectedDoctorId={selectedDoctorId}
              setSelectedDoctorId={setSelectedDoctorId}
              doctorList={doctorList}
            />

            {/* 캘린더 메인 뷰 */}
            <div className="content-area flex flex-col flex-1 h-full min-h-0 bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
              
              {/* 캘린더 상단 제목 및 버튼 */}
              <div className="flex justify-between items-end p-6 pb-2 shrink-0">
                <div>
                  <h2 className="text-xl font-bold text-slate-900 mb-1">
                    {viewType === 'COMMON' ? '병원 공통 일정' : '의사별 개별 일정'}
                  </h2>
                  <p className="text-[10px] text-slate-400 font-bold uppercase tracking-widest">
                    {viewType === 'COMMON' ? 'HOSPITAL SHARED CALENDAR' : `DOCTOR ID: ${selectedDoctorId}`}
                  </p>
                </div>
                <button
                  onClick={() => { setSelectedEvent(null); setIsModalOpen(true); }}
                  className="px-4 py-2 bg-blue-600 text-white rounded-[6px] text-[13px] font-bold hover:bg-blue-700 transition shadow-sm"
                >
                  + 일정 생성
                </button>
              </div>

              {/* FullCalendar */}
              <div className="flex-1 p-6 overflow-hidden">
                <FullCalendar
                  key={`${viewType}-${selectedDoctorId}`}
                  plugins={[dayGridPlugin, timeGridPlugin, interactionPlugin]}
                  initialView="dayGridMonth"
                  headerToolbar={{
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay'
                  }}
                  slotMinTime="08:00:00"
                  slotMaxTime="20:00:00"
                  slotEventOverlap={false}
                  locale="ko"
                  height="100%"
                  events={events}
                  editable={true}
                  selectable={true}
                  dayMaxEvents={true}
                  select={handleDateSelect}
                  eventClick={handleEventClick}
                  eventDrop={handleEventDrop}
                />
              </div>
            </div>
            
          </div>
        </main>
      </div>
    </div>
  );
}

export default DoctorCalendarPage;