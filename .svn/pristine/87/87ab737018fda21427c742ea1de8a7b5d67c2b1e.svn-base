import React, { useState, useEffect, useMemo, useRef } from 'react';
import axios from 'axios';
import { Client } from '@stomp/stompjs';
import SockJS from 'sockjs-client';

const WaitingList = () => {
    const [patients, setPatients] = useState([]);
    const [currentTime, setCurrentTime] = useState(new Date());
    const calledPatients = useRef(new Set());

    const isInitialLoad = useRef(true);

    const getStatusInfo = (code) => {
        const statusMap = {
            '001': { label: 'ëŒ€ê¸°', color: 'bg-slate-100 text-slate-400' },
            '002': { label: 'ì§„ë£ŒëŒ€ê¸°', color: 'bg-slate-100 text-slate-400' },
            '003': { label: 'ì§„ë£Œì¤‘', color: 'bg-green-100 text-green-700' },
            '004': { label: 'ìˆ˜ë‚©ëŒ€ê¸°', color: 'bg-blue-100 text-blue-700' },
            '005': { label: 'ìˆ˜ë‚©ì™„ë£Œ', color: 'bg-gray-200 text-gray-500' }
        };
        return statusMap[code] || { label: 'ëŒ€ê¸°', color: 'bg-slate-100 text-slate-400' };
    };

    const announcePatient = (patientName, doctorName) => {
        if (!window.speechSynthesis) return;

        const text = `${patientName} ë‹˜, ${doctorName || 'ë°•ì˜ì‚¬'}ë‹˜ ì§„ë£Œì‹¤ë¡œ ë“¤ì–´ì˜¤ì„¸ìš”.`;
        const utterance = new SpeechSynthesisUtterance(text);
        
        utterance.lang = 'ko-KR'; // í•œêµ­ì–´
        utterance.rate = 0.9;      // ë§í•˜ê¸° ì†ë„ (ì¡°ê¸ˆ ì²œì²œíˆ)
        utterance.pitch = 1.2;       // ëª©ì†Œë¦¬ í†¤
        utterance.volume = 1.0;   // ë³¼ë¥¨ ìµœëŒ€
        
        window.speechSynthesis.speak(utterance);
    };

    const patientWaitingList = async () => {
        try {
            const response = await axios.get('/api/waiting/realTime');

            const data = Array.isArray(response.data) ? response.data : [];
            
            const mappedData = data.map(p => ({ 
                id: p.patientNo,
                name: p.patientName,
                doctor: p.employeeName,
                isReserved: p.registrationVO?.reservationYn === 'Y',
                statusCode: p.registrationVO?.registrationStatus
            }));

            mappedData.forEach(p => {
                if (p.statusCode === '003') {
                    console.log("ğŸ“¢ í˜¸ì¶œ ì‹œë„:", p.name);
                    if (!isInitialLoad.current && !calledPatients.current.has(p.id)) {
                        announcePatient(p.name, p.doctor);
                    }
                    calledPatients.current.add(p.id);
                }
            });
            
            setPatients(mappedData);

            if (isInitialLoad.current) {
                isInitialLoad.current = false;
            }
        } catch (error) {
            console.error("ëŒ€ê¸° ëª…ë‹¨ ë¡œë“œ ì‹¤íŒ¨:", error);
        }
    };

    useEffect(() => {
        patientWaitingList();

        const timer = setInterval(() => setCurrentTime(new Date()), 1000);

        const socket = new SockJS('http://localhost:8060/ws/chat');
        const stompClient = new Client({
            webSocketFactory: () => socket,
            onConnect: () => {
                console.log('STOMP Connected');
                stompClient.subscribe('/topic/waitingList', (message) => {
                    if (message.body === "REFRESH") {
                        patientWaitingList(); 
                    }
                });
            },
        });

        stompClient.activate();

        return () => {
            clearInterval(timer);
            stompClient.deactivate();
        };
    }, []);

    const columns = useMemo(() => {
        const chunks = [];
        for (let i = 0; i < 32; i += 8) {
            chunks.push(patients.slice(i, i + 8));
        }
        return chunks;
    }, [patients]);

    return (
        <div className="min-h-screen p-8 bg-slate-50">
            <header className="flex items-center justify-between p-6 mb-8 bg-white shadow-lg rounded-3xl border-l-[12px] border-blue-600">
                <div>
                    <h1 className="text-3xl font-black text-slate-800">
                        SB ì •í˜•ì™¸ê³¼ <span className="text-blue-600 ml-2">ì‹¤ì‹œê°„ ëŒ€ê¸° í˜„í™©</span>
                    </h1>
                    {/* í…ŒìŠ¤íŠ¸ìš© ë²„íŠ¼: ì´ê±¸ ëˆ„ë¥´ë©´ ì´ë¯¸ ë¶€ë¥¸ í™˜ìë„ ë‹¤ì‹œ ë¶€ë¥¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤! */}
                        <button 
                            onClick={() => {
                                // í˜„ì¬ ìƒíƒœê°€ '003'ì¸ í™˜ì í•œ ëª…ì„ ì°¾ì•„ ê°•ì œë¡œ ë¶€ë¦…ë‹ˆë‹¤.
                                const currentPatient = patients.find(p => p.statusCode === '003');
                                if (currentPatient) {
                                    announcePatient(currentPatient.name, currentPatient.doctor);
                                } else {
                                    alert("í˜„ì¬ 'ì§„ë£Œì¤‘' ìƒíƒœì¸ í™˜ìê°€ ì—†ì–´ì„œ í…ŒìŠ¤íŠ¸ë¥¼ í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                                }
                            }}
                            className="bg-orange-500 text-white text-xs px-3 py-1 rounded-full hover:bg-orange-600 shadow-md transition-all active:scale-95"
                        >
                            ğŸ”Š í˜„ì¬ í™˜ì ë‹¤ì‹œ í˜¸ì¶œ (í…ŒìŠ¤íŠ¸ìš©)
                        </button>
                </div>
                <div className="text-right">
                    <div className="text-lg text-slate-500 font-semibold">
                        {currentTime.toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'short' })}
                    </div>
                    <div className="text-5xl font-black text-blue-600 tracking-tighter">
                        {currentTime.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false })}
                    </div>
                </div>
            </header>

            <div className="grid grid-cols-4 gap-6" style={{ height: 'calc(100vh - 22rem)' }}>
                {columns.map((col, colIdx) => (
                    <div key={colIdx} className="bg-white rounded-[2rem] shadow-md border border-slate-100 overflow-hidden">
                        <table className="w-full">
                            <thead className="bg-slate-50 border-b border-slate-100">
                                <tr className="text-slate-400 text-sm font-bold">
                                    <th className="py-4 w-16 text-center">ìˆœë²ˆ</th>
                                    <th className="py-4 text-left">í™˜ìëª…</th>
                                    <th className="py-4 w-24 text-center">ìƒíƒœ</th>
                                </tr>
                            </thead>
                            <tbody>
                                {col.map((p, pIdx) => {
                                    const statusInfo = getStatusInfo(p.statusCode);
                                    const isCalling = p.statusCode === '003'; // ì§„ë£Œì¤‘ ì½”ë“œ
                                    
                                    return (
                                        <tr key={p.id} className={`border-b border-slate-50 ${isCalling ? 'bg-blue-50/50' : ''}`} style={{ height: '5.5rem' }}>
                                            <td className="text-center">
                                                <span className={`text-lg font-bold ${isCalling ? 'text-blue-600' : 'text-slate-300'}`}>
                                                    {(colIdx * 8 + pIdx + 1).toString().padStart(2, '0')}
                                                </span>
                                            </td>

                                            <td className="py-3">
                                                <div className="flex flex-col justify-center">
                                                    <div className="flex items-center gap-2">
                                                        <span className={`text-2xl font-black ${isCalling ? 'text-slate-900' : 'text-slate-700'} leading-tight`}>
                                                            {p.name}
                                                        </span>
                                                        {p.isReserved && (
                                                            <span className="bg-blue-100 text-blue-600 text-[10px] px-2 py-0.5 rounded-full font-bold border border-blue-200">
                                                                ì˜ˆì•½
                                                            </span>
                                                        )}
                                                    </div>
                                                    <span className={`text-sm font-bold mt-1 ${isCalling ? 'text-blue-600' : 'text-slate-400'}`}>
                                                        {p.doctor ? `${p.doctor} ì›ì¥ë‹˜` : 'ì§„ë£Œì‹¤ ë°°ì •ì¤‘'}
                                                    </span>
                                                </div>
                                            </td>

                                            <td className="text-center">
                                                <div className="flex flex-col items-center justify-center gap-1">
                                                    {isCalling && <div className="status-dot-small animate-pulse"></div>}
                                                    <span className={`text-xs font-bold px-3 py-1 rounded-lg ${statusInfo.color}`}>
                                                        {statusInfo.label}
                                                    </span>
                                                </div>
                                            </td>
                                        </tr>
                                    );
                                })}
                            </tbody>
                        </table>
                    </div>
                ))}
            </div>

            <footer className="mt-10">
                <div className="flex items-center gap-4 p-5 bg-slate-900 rounded-[1.5rem] shadow-xl overflow-hidden border-b-4 border-blue-500">
                    <div className="flex items-center gap-2 bg-blue-600 px-4 py-2 rounded-xl text-white font-black text-sm shrink-0">
                        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="3" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                        ì•ˆë‚´ì‚¬í•­
                    </div>
                    <div className="flex-1 text-white font-medium text-lg italic tracking-wide overflow-hidden">
                        <marquee scrollamount="6">
                            ì„±í•¨ì´ í˜¸ì¶œëœ í™˜ìë¶„ê»˜ì„œëŠ” ì§„ë£Œì‹¤ë¡œ ì…ì¥í•´ ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤. â€¢ ì˜ˆì•½ í™˜ìë¶„ë“¤ì€ ë„ì°© ì‹œ ë°ìŠ¤í¬ì— ë°˜ë“œì‹œ ë§ì”€í•´ ì£¼ì„¸ìš”. â€¢ ì§„ë£Œ ìƒí™©ì— ë”°ë¼ ëŒ€ê¸° ì‹œê°„ì´ ë‹¤ì†Œ ê¸¸ì–´ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                        </marquee>
                    </div>
                </div>
            </footer>
        </div>
    );
};

export default WaitingList;