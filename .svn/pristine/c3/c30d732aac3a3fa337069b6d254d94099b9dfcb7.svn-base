import React, { useEffect, useState } from 'react';
import api from '../api/axios';
import { useNavigate } from 'react-router-dom';
import ForcePwModal from '../components/common/ForcePwModal';

const Dashboard = () => {
  const navigate = useNavigate();
  const [serverMsg, setServerMsg] = useState('');
  const [emName, setEmName] = useState('');
  const [roles, setRoles] = useState([]);
  const [showForceModal, setShowForceModal] = useState(false);

  // ë°±ì—”ë“œ ì„œë²„ ì£¼ì†Œ ìƒìˆ˜í™” ì‹œí‚µì‹œë‹¤...
  const SPRING_URL = "http://localhost:8060";

  useEffect(() => {
    const initDashboard = async () => {
      try {
        // ë‚´ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        const res = await api.get('/auth/me');
        
        setEmName(res.data.employeeName);
        setRoles(res.data.roles);
        setServerMsg('ë°±ì—”ë“œ ì—°ê²° ğŸŸ¢');

        // pwTempYn === 'Y' ì´ë©´ ê°•ì œë¡œ ëª¨ë‹¬ ë„ìš°ê¸°
        if (res.data.pwTempYn === 'Y') {
             setShowForceModal(true);
        }

      } catch (err) {
        console.error("ë°ì´í„° ë¡œë”© ì‹¤íŒ¨:", err);
        setServerMsg('ì„œë²„ ì‘ë‹µ ì—†ìŒ ğŸ”´');

      }
    };
    initDashboard();
  }, []);

  // ê¶Œí•œ ì²´í¬ í•¨ìˆ˜
  const hasAnyRole = (...requiredRoles) =>
    requiredRoles.some(role => roles.includes(role));

  // ë§ˆì´í˜ì´ì§€ ì´ë™ í•¨ìˆ˜
  const handleMypage=()=>{
    // navigate('/mypage');
    window.location.href = `${SPRING_URL}/employee/mypage`
  }

  // ë¡œê·¸ì•„ì›ƒ í•¨ìˆ˜
  const handleLogout = () => {
      // ë¡œê·¸ì•„ì›ƒì‹œ ì¿ í‚¤ ì§€ìš°ê³  í™”ë©´ ì´ë™í•´ì•¼í•¨
      window.location.href = `${SPRING_URL}/logout`
  };

  // ì§ì±…ë³„ ë©”ë‰´
  const actorMenu = [

    // ì˜ì‚¬ (ì™¸ë˜)
    { 
      icon: "ğŸ‘¨â€âš•ï¸",
      label: "ì˜ì‚¬(ì™¸)",
      path : `${SPRING_URL}/doctor/outpatient`,
      allow: ["ROLE_DOCTOR", "ROLE_ADMIN"]
    },


    // ê°„í˜¸ì‚¬ (ì™¸ë˜)
    { icon: "ğŸ©º",
      label: "ì™¸ë˜ ê°„í˜¸ì‚¬",
      path : `${SPRING_URL}/nurse/outpatientnurse`,
      allow: ["ROLE_NURSE_OUT", "ROLE_ADMIN"]
    },
    
    // ì›ë¬´ê³¼
    { 
      icon: "ğŸ“",
      label: "ì›ë¬´ê³¼",
      path : `${SPRING_URL}/management/reception`,
      allow: ["ROLE_OFFICE", "ROLE_ADMIN"]
    },

    
    // ë°©ì‚¬ì„ ì‚¬ (ì˜ìƒì‹¤)
    { 
      icon: "ğŸ’»",
      label: "ë°©ì‚¬ì„ ì‚¬",
      path : `${SPRING_URL}/radiologist/workview`,
      allow: ["ROLE_RADIOLOGIST", "ROLE_ADMIN"]
    },
        
    // ê´€ë¦¬ì - ê³„ì • ê´€ë¦¬
    {
      icon: "ğŸ›ï¸",
      label: "ê³„ì • ê´€ë¦¬",
      type: "react",
      path : "/admin/employees",
      allow: ["ROLE_ADMIN"],
      hideRestricted: true
    },
    
    // ì˜ì‚¬ (ì…ì›)
    { 
      icon: "ğŸ¥",
      label: "ì˜ì‚¬(ì…)",
      path : `${SPRING_URL}/doctor/inpatient/main`,
      allow: ["ROLE_DOCTOR", "ROLE_ADMIN"],
      //viewAllow : ["ROLE_DOCTOR", "ROLE_ADMIN"]
    },
    
    // ê°„í˜¸ì‚¬ (ì…ì›)
    { 
      icon: "ğŸ›ï¸",
      label: "ì…ì› ê°„í˜¸ì‚¬",
      path : `${SPRING_URL}/nurse/inpatient`,
      allow: ["ROLE_NURSE_IN", "ROLE_ADMIN"],
      viewAllow : ["ROLE_NURSE_IN", "ROLE_NURSE_OUT", "ROLE_ADMIN"]
    },

    
    // ì•½ì‚¬
    {
      icon: "ğŸ’Š",
      label: "ì•½ì‚¬",
      path : `${SPRING_URL}/pharmacist/workview`,
      allow: ["ROLE_PHARMACIST", "ROLE_ADMIN"]
    },

    // ë¬¼ë¦¬ì¹˜ë£Œì‹¤
    { 
      icon: "ğŸ©¹",
      label: "ë¬¼ë¦¬ì¹˜ë£Œì‚¬",
      path : `${SPRING_URL}/`,
      allow: ["ROLE_THERAPIST", "ROLE_ADMIN"]
    },

        
    // ê´€ë¦¬ì - ë§¤í¬ë¡œ ê´€ë¦¬
    {
      icon: "âŒ¨ï¸",
      label: "ë§¤í¬ë¡œ ê´€ë¦¬",
      type: "react",
      path : "/admin/macro",
      allow: ["ROLE_ADMIN"],
      hideRestricted: true
    },

  ];
  
  // ê¸°ëŠ¥ë³„ ë©”ë‰´
  const functionMenu = [

    // ê´€ë¦¬ì - ê³µì§€ì‚¬í•­ ê´€ë¦¬
    {
      icon: "ğŸ”Š",
      label: "ê³µì§€ì‚¬í•­ (ê´€ë¦¬ììš©)",
      path : `${SPRING_URL}/admin/notice/list`,
      allow: ["ROLE_ADMIN"],
      hideRestricted: true
    },

    // ê´€ë¦¬ììš© - ì¼ì •
    {
      icon: "ğŸ“…",
      label: "ì¼ì • (ê´€ë¦¬ììš©)",
      type: "react",
      path : "/calendar",
      allow: ["ROLE_ADMIN"],
      hideRestricted: true
    },

    
    // ê´€ë¦¬ì - ì¬ê³ &ë¬¼í’ˆ
    { 
      icon: "ğŸ›ï¸",
      label: "ì¬ê³  ê´€ë¦¬",
      path : `${SPRING_URL}/`,
      allow: ["ROLE_ADMIN"],
      hideRestricted: true
    },
    
    // ì„œë¥˜
    {
      icon: "ğŸ—ƒï¸",
      label: "ì„œë¥˜ ê´€ë¦¬",
      path : `${SPRING_URL}/certificate/main`,
      allow: [
        "ROLE_DOCTOR",
        "ROLE_NURSE_OUT",
        "ROLE_NURSE_IN",
        "ROLE_RADIOLOGIST",
        "ROLE_OFFICE",
        "ROLE_PHARMACIST",
        "ROLE_THERAPIST",
        "ROLE_ADMIN"
      ]
    },

    // ê³µí†µ - ê³µì§€ì‚¬í•­
    {
      icon: "ğŸ”Š",
      label: "ê³µì§€ì‚¬í•­",
      path : `${SPRING_URL}/notice/main`,
      allow: [
        "ROLE_DOCTOR",
        "ROLE_NURSE_OUT",
        "ROLE_NURSE_IN",
        "ROLE_RADIOLOGIST",
        "ROLE_OFFICE",
        "ROLE_PHARMACIST",
        "ROLE_THERAPIST"
      ]
    },

    // ê³µí†µ - ì¼ì •
    {
      icon: "ğŸ—“ï¸",
      label: "ì¼ì •",
      path : `${SPRING_URL}/schedule/main`,
      allow: [
        "ROLE_DOCTOR",
        "ROLE_NURSE_OUT",
        "ROLE_NURSE_IN",
        "ROLE_RADIOLOGIST",
        "ROLE_OFFICE",
        "ROLE_PHARMACIST",
        "ROLE_THERAPIST"
      ]
    },

    
    // ê³µí†µ - ì¬ê³ &ë¬¼í’ˆ ì£¼ë¬¸
    {
      icon: "ğŸ›’",
      label: "ë¬¼í’ˆ ì£¼ë¬¸",
      path : `${SPRING_URL}/order/drug`,
      allow: [
        "ROLE_DOCTOR",
        "ROLE_NURSE_OUT",
        "ROLE_NURSE_IN",
        "ROLE_RADIOLOGIST",
        "ROLE_OFFICE",
        "ROLE_PHARMACIST",
        "ROLE_THERAPIST"
      ]
    }
    
  ];

  // ë©”ë‰´ ê·¸ë¦¬ë“œì— ëŒ€í•œ í•¨ìˆ˜
  const renderMenuGrid = (items, gridClass) => (
    <div className={`grid ${gridClass} gap-6 w-[100%] justify-items-center`}>
      {items.map((item, index) => {
        const active = hasAnyRole(...item.allow);

        // ì˜ì‚¬ë§Œ(ì™¸ë˜,ì…ì›), ê°„í˜¸ì‚¬ë§Œ(ì™¸ë˜,ì…ì›) ë…¸ì¶œë˜ê²Œí•˜ê¸°
        if (item.viewAllow) {
            const canSee = hasAnyRole(...item.viewAllow);
            if (!canSee) return null;
        }
        // ê¶Œí•œ ì—†ìœ¼ë©´ ìˆ¨ê¸°ê¸°
        if (item.hideRestricted && !active) return null;

        return (
          <div key={index}
            className={`app-card w-[150px] h-[150px] flex flex-col justify-center items-center rounded-2xl border border-slate-100 shadow-sm
              ${active ? 'cursor-pointer hover:bg-slate-50 transition-all' : 'opacity-30 cursor-not-allowed grayscale bg-slate-50'}`}
            onClick={() => {
              if (!active) { alert("ì ‘ê·¼ ê¶Œí•œ ì—†ìŒ!"); return; }
              if (item.type === 'react') { navigate(item.path); return; }
              if (!item.path || item.path === `${SPRING_URL}/`) { alert("ğŸš§ ì¤€ ë¹„ ì¤‘ ğŸš§ \n ~ ì•„ì§ ì—°ê²°ë˜ì§€ ì•Šì€ í˜ì´ì§€ ì…ë‹ˆë‹¹~ "); return; }
              window.location.href = item.path;
            }}
          >
            <div className="app-icon-box">{item.icon}</div>
            <div className="app-label-wrapper">
              <p className="app-label">{item.label}</p>
            </div>
          </div>
        );
      })}
    </div>
  );

  return (
    <div className="flex flex-col h-screen bg-white font-pretendard">
      {/* ì„ì‹œ ë¹„ë°€ë²ˆí˜¸ ëª¨ë‹¬ */}
      {showForceModal && <ForcePwModal springUrl={SPRING_URL} />}

      {/* í—¤ë” */}
      <header className="p-8 px-16 flex justify-between items-center">
        <div className="flex items-center gap-2">
          <span className="text-3xl font-black tracking-tighter text-slate-900">SB</span>
          <span className="text-xl font-bold text-slate-700">ì •í˜•ì™¸ê³¼</span>
        </div>
        <span className="text-xs text-gray-400">{serverMsg}</span>
      </header>

      {/* ë©”ì¸ */}
      <main className="flex-1 flex items-start justify-center overflow-y-auto pb-10">
        {/* ì „ì²´ ì»¨í…Œì´ë„ˆ */}
        <div className="flex items-center gap-20 max-w-screen-2xl w-full px-16 h-full">

          {/* ì™¼ìª½ : ì´ë¯¸ì§€ ë° í”„ë¡œí•„ */}
          <div className="w-[60%] flex flex-col justify-center gap-10">
            <div className="main-visual-container w-full rounded-3xl overflow-hidden shadow-lg">
              <img
                src="https://media.istockphoto.com/id/1334654540/ko/%EB%B2%A1%ED%84%B0/%EA%B1%B4%EA%B0%95-%EA%B4%80%EB%A6%AC-%EA%B2%80%EC%A7%84-%EC%A0%95%ED%98%95-%EC%99%B8%EA%B3%BC-%EC%9D%98%EC%82%AC-%EB%BC%88%EC%99%80-%EC%9D%B8%EA%B0%84%EC%9D%98-%EB%B0%9C-%EC%A0%95%ED%98%95-%EC%99%B8%EA%B3%BC-%EC%9D%98%EC%82%AC-%EC%9D%98%EB%A3%8C-%EC%A7%84%EB%8B%A8-%EB%B0%8F-%EA%B2%80%EC%82%AC-%EB%B0%9C%EC%9D%84%ED%95%98%EA%B3%A0-%EB%B0%9C-%EB%B3%80%ED%98%95-%EB%B0%9C%EC%9D%98-%EB%B3%91%EB%A6%AC%ED%95%99-%ED%8F%89%ED%8F%89%ED%95%9C-%EB%B0%9C-%EA%B4%80%EC%A0%88-%EB%8B%A4%EB%A6%AC-%ED%86%B5%EC%A6%9D-%EB%B2%A1%ED%84%B0.jpg?s=612x612&w=0&k=20&c=jTDI0Dzh1hoXcZAUSzHmkMevmWNYlyT21p389qAEt3g="
                alt="Medical Visual"
                className="w-full h-full object-cover"
              />
            </div>

            <div className="flex flex-col gap-8 px-2">
              <div className="flex items-center gap-3 bg-slate-50 self-start px-5 py-2.5 rounded-full border border-slate-100 shadow-sm">
                <div className="w-8 h-8 rounded-full bg-slate-200 flex items-center justify-center text-sm">ğŸ‘¤</div>
                <div className="flex items-center gap-2">
                  <span className="font-bold text-slate-800 text-lg">{emName}ë‹˜</span>
                </div>
              </div>
              <div className="flex gap-8 items-center pl-2">
                <div className="relative">
                  <button className="util-btn" onClick={handleMypage}>
                    <span className="text-2xl font-black tracking-tighter text-slate-900">MY</span>
                  </button>
                  <span className="absolute -top-1 -right-1 w-2.5 h-2.5 bg-red-500 rounded-full border-2 border-white"></span>
                </div>
                <button className="util-btn" onClick={handleLogout}>
                  <img src="https://img.icons8.com/?size=100&id=vGj0AluRnTSa&format=png&color=000000" alt="Settings" width="40" />
                </button>
              </div>
            </div>
          </div>

          {/* ì˜¤ë¥¸ìª½ : ë©”ë‰´ ì„¹ì…˜ */}
          <div className="flex flex-col h-full w-full max-w-[1000px] ">
          
            <div className="flex-1 flex flex-col justify-start pb-4 pl-2">
              <h3 className="text-sm font-bold text-slate-600 mb-4 px-2">ë¶€ì„œë³„</h3>
              {renderMenuGrid(actorMenu, roles.includes("ROLE_ADMIN") ? "grid-cols-5" : "grid-cols-4")}
            </div>

            <hr className="border-t border-slate-200 w-[95%] mx-auto" />

            <div className="flex-1 flex flex-col justify-start pt-8 pl-2">
              <h3 className="text-sm font-bold text-slate-600 mb-4 px-2">ê¸°ëŠ¥ë³„</h3>
              <div className="pl-10 px-14">
                {renderMenuGrid(functionMenu, "grid-cols-4")}
              </div>
            </div>

          </div>

        </div>
      </main>

      {/* <footer className="absolute bottom-8 right-10 text-slate-400 text-sm">
        <button onClick={handleLogout} className="util-btn1 hover:text-slate-800 hover:font-bold">
          ê´€ë¦¬ì
        </button>
      </footer> */}

    </div>
  );
};

export default Dashboard;