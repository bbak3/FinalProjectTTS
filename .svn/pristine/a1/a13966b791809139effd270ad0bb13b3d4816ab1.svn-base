import React, { useState, useEffect, useCallback } from 'react';
import Header from '../../components/layout/Header.jsx';
import LeftAdmin from "../../components/layout/LeftAdmin.jsx";
import axios from 'axios';
import { 
  BarChart2, User, Monitor, FileText, Package, Megaphone, Calendar as CalendarIcon, 
  Search, Home, Bell, 
  Settings, LayoutGrid, Stethoscope, Pill, Activity, FolderOpen, Users, 
  Plus
} from 'lucide-react';


// --- 설정 ---
const API_BASE_URL = 'http://localhost:8060/api/macro';

const CURRENT_USER_ID = 26020908; 

const MAIN_NAV_ITEMS = [
  { id: 'stats', label: '통계', icon: <BarChart2 size={20} /> },
  { id: 'account', label: '계정', icon: <User size={20} /> },
  { id: 'macro', label: '매크로', icon: <Monitor size={20} />, active: true },
  { id: 'forms', label: '증명서 양식', icon: <FileText size={20} /> },
  { id: 'stock', label: '물품 재고', icon: <Package size={20} /> },
  { id: 'notice', label: '공지사항', icon: <Megaphone size={20} /> },
  { id: 'calendar', label: '공통 일정', icon: <CalendarIcon size={20} /> },
];

const MACRO_CATEGORIES = [
  { id: 'ALL', label: '전체 매크로 조회', icon: <LayoutGrid size={16} /> },
  { id: '의사', label: '의사 전용 세트', icon: <Stethoscope size={16} /> },
  { id: '약사', label: '약사 세트', icon: <Pill size={16} /> },
  { id: '방사선사', label: '방사선사 세트', icon: <Activity size={16} /> },
  { id: '원무과', label: '원무과 세트', icon: <FolderOpen size={16} /> },
  { id: '외래간호사', label: '외래간호사 세트', icon: <Users size={16} /> },
  { id: '입원간호사', label: '입원간호사 세트', icon: <Users size={16} /> },
];

export default function MacroPage() {
  const [macroList, setMacroList] = useState([]); 
  const [selectedCategory, setSelectedCategory] = useState('ALL'); 
  const [searchTerm, setSearchTerm] = useState(''); 
  
  // 키 값을 camelCase로 변경
  const [formData, setFormData] = useState({
    macroNo: 0,
    macroName: '',
    macroType: 'DOCTOR', 
    macroContent: '',
    employeeNo: CURRENT_USER_ID
  });

  // API Functions
  const fetchMacros = useCallback(async () => {
    try {
      const response = await axios.get(`${API_BASE_URL}/list`, {
        params: { employeeNo: CURRENT_USER_ID }
      });
      // 서버에서도 camelCase로 데이터를 내려준다고 가정합니다.
      setMacroList(response.data || []);
    } catch (error) {
      console.error("로드 실패:", error);
      // 더미 데이터도 camelCase로 통일
      setMacroList([
        { macroNo: 1, macroName: '요추 추간판 탈출증(HLD) 루틴', macroType: 'DOCTOR', macroContent: '상세 내용...' },
        { macroNo: 2, macroName: '복약지도 기본 A안', macroType: 'PHARMACY', macroContent: '식후 30분 복용...' },
      ]);
    }
  }, []);

  useEffect(() => {
    fetchMacros();
  }, [fetchMacros]);

  const handleSave = async () => {
    if (!formData.macroName.trim()) return alert("매크로 명칭을 입력해주세요.");
    
    try {
      // ✅ 수정됨: formData.macroNo 접근
      const url = formData.macroNo === 0 ? `${API_BASE_URL}/add` : `${API_BASE_URL}/update`;
      
      // ✅ formData의 키값이 이미 camelCase이므로 변환 없이 그대로 전송 가능
      await axios.post(url, formData);
      
      alert(formData.macroNo === 0 ? "등록되었습니다." : "수정되었습니다.");
      fetchMacros();
      if (formData.macroNo === 0) handleNewMacro();
    } catch (error) {
      console.error("저장 오류:", error);
      alert("오류 발생: 서버 로그를 확인하세요.");
    }
  };

  const handleDelete = async (macroNo, e) => {
    e.stopPropagation();
    if (!window.confirm("삭제하시겠습니까?")) return;
    try {
      await axios.post(`${API_BASE_URL}/delete/${macroNo}`); 
      
      alert("삭제되었습니다.");
      fetchMacros();
      if (formData.macroNo === macroNo) handleNewMacro();
    } catch (error) {
      alert("삭제 실패");
    }
  };

  const handleNewMacro = () => {
    setFormData({
      macroNo: formData.macroNo, macroName: formData.macroName, macroType: formData.macroType, macroContent: formData.macroContent 
    });
  };

  const handleSelectMacro = (macro) => {
    // 서버에서 받은 데이터(macro)가 camelCase라면 그대로 복사 가능
    setFormData({ ...macro });
  };

  const handleInputChange = (e) => {
    const { name, value } = e.target;
    setFormData(prev => ({ ...prev, [name]: value }));
  };

  // --- Dynamic Label Logic ---
  const getContentLabel = (type) => {
    switch(type) {
      case 'DOCTOR': return '기본 오더 멘트 (진료 기록용)';
      case 'PHARMACY': return '약사 복약지도 양식';
      case 'RADIO': return '촬영 특이사항 및 가이드';
      case 'BILLING': return '수납/청구 메모';
      case 'NURSE_OP': 
      case 'NURSE_WARD': return '간호 기록 양식';
      default: return '매크로 상세 내용';
    }
  };

  const filteredList = macroList.filter(item => {
    if (!item || !item.macroName) return false;

    const matchSearch = item.macroName.toLowerCase().includes(searchTerm.toLowerCase());
    const matchCategory = selectedCategory === 'ALL' || item.macroType === selectedCategory;
    return matchSearch && matchCategory;
  });


  return (
    <div className="flex flex-col h-screen bg-slate-50 font-sans text-slate-800">
      
      {/* Header */}
      <header className="h-16 bg-white border-b border-slate-200 flex items-center justify-between px-6 shrink-0 z-10">
        <div className="flex items-center gap-2">
          <span className="text-2xl font-black text-blue-600 tracking-tighter">SB</span>
          <span className="text-xl font-bold text-slate-900 tracking-tight">정형외과</span>
        </div>
        <div className="flex items-center gap-4 text-slate-400">
          <Home className="w-5 h-5 cursor-pointer hover:text-blue-600" />
          <Search className="w-5 h-5 cursor-pointer hover:text-blue-600" />
          <Bell className="w-5 h-5 cursor-pointer hover:text-blue-600" />
          <div className="w-8 h-8 bg-slate-200 rounded-full flex items-center justify-center text-xs font-bold text-slate-500">
            36
          </div>
        </div>
      </header>

      <div className="flex flex-1 overflow-hidden">
        
        {/* Left Sidebar */}
        <nav className="w-[70px] bg-white border-r border-slate-200 flex flex-col py-4 items-center gap-4 shrink-0">
          {MAIN_NAV_ITEMS.map((item) => (
            <button key={item.id} className={`flex flex-col items-center gap-1 p-2 rounded-lg transition-all w-16 ${item.active ? 'bg-blue-50 text-blue-600' : 'text-slate-500 hover:bg-slate-50 hover:text-slate-700'}`}>
              {item.icon}
              <span className={`text-[10px] ${item.active ? 'font-bold' : 'font-medium'}`}>{item.label}</span>
            </button>
          ))}
        </nav>

        {/* Category Menu */}
        <aside className="w-[240px] bg-white border-r border-slate-200 flex flex-col py-6 px-4 shrink-0 overflow-y-auto">
          <div className="mb-6 pl-2 border-l-4 border-blue-600 h-4 flex items-center">
            <h2 className="text-sm font-bold text-slate-900 leading-none">매크로 관리 메뉴</h2>
          </div>
          <div className="flex flex-col gap-1">
            {MACRO_CATEGORIES.map((cat) => (
              <button key={cat.id} onClick={() => setSelectedCategory(cat.id)} className={`w-full text-left px-4 py-3.5 rounded-lg text-[13px] flex items-center justify-between transition-all ${selectedCategory === cat.id ? 'bg-blue-50 text-blue-600 font-bold shadow-sm' : 'text-slate-500 font-medium hover:bg-slate-50'}`}>
                <span>{cat.label}</span>
                {selectedCategory === cat.id && <div className="w-1.5 h-1.5 rounded-full bg-blue-600"></div>}
              </button>
            ))}
          </div>
        </aside>

        {/* List Section */}
        <section className="w-[320px] bg-white border-r border-slate-200 flex flex-col shrink-0">
          <div className="p-6 border-b border-slate-100 bg-white">
            <div className="flex justify-between items-center mb-4">
              <h2 className="text-lg font-bold text-slate-900">매크로 목록</h2>
              <button onClick={handleNewMacro} className="text-blue-600 text-[11px] font-bold hover:underline flex items-center">
                <Plus size={12} className="mr-0.5" /> 새 매크로
              </button>
            </div>
            <div className="relative">
              <input type="text" placeholder="매크로 검색..." value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} className="w-full pl-9 pr-3 py-2.5 bg-slate-50 border border-slate-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-100 transition-all placeholder:text-slate-400" />
              <Search className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" size={16} />
            </div>
          </div>
          <div className="flex-1 overflow-y-auto p-4 space-y-3 bg-white">
            {filteredList.length === 0 ? (
              <div className="text-center py-10 text-slate-400 text-xs">등록된 매크로가 없습니다.</div>
            ) : (
              filteredList.map((macro) => (
                // ✅ 수정됨: macro.macroNo, macro.macroType 등
                <div key={macro.macroNo} onClick={() => handleSelectMacro(macro)} className={`p-5 rounded-xl border transition-all cursor-pointer group hover:shadow-md ${formData.macroNo === macro.macroNo ? 'bg-white border-blue-500 ring-1 ring-blue-500 shadow-sm' : 'bg-white border-slate-200 hover:border-blue-200'}`}>
                  <div className="flex items-center gap-1.5 mb-2">
                    {macro.macroType === 'DOCTOR' ? <Stethoscope size={12} className="text-slate-500" /> : <Monitor size={12} className="text-slate-500" />}
                    <span className="text-[11px] font-bold text-slate-500">{MACRO_CATEGORIES.find(c => c.id === macro.macroType)?.label.replace(' 세트', '') || macro.macroType}</span>
                  </div>
                  <h3 className="font-bold text-slate-800 text-sm mb-4 leading-tight">{macro.macroName}</h3>
                  <div className="flex gap-3 text-[11px] font-medium">
                    <button onClick={(e) => {e.stopPropagation(); handleSelectMacro(macro);}} className="text-blue-600 hover:underline">수정</button>
                    <button onClick={(e) => handleDelete(macro.macroNo, e)} className="text-red-500 hover:underline">삭제</button>
                  </div>
                </div>
              ))
            )}
          </div>
        </section>

        {/* Main Form Section */}
        <main className="flex-1 bg-white flex flex-col min-w-[600px] overflow-hidden">
          <div className="h-[72px] px-8 border-b border-slate-100 flex items-center justify-between shrink-0">
            <div>
              {/* ✅ 수정됨: formData.macroNo */}
              <h2 className="text-xl font-bold text-slate-900 mb-1">{formData.macroNo === 0 ? "새 매크로 생성" : "매크로 수정"}</h2>
              <p className="text-[10px] text-slate-400 font-bold tracking-widest uppercase">MACRO CONTENT CONFIGURATION</p>
            </div>
            <button onClick={handleSave} className="px-6 py-2.5 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm font-bold shadow-md shadow-blue-200/50 transition-all flex items-center gap-1.5">
              저장 및 등록
            </button>
          </div>

          <div className="flex-1 overflow-y-auto p-8 bg-white relative">
            <div className="grid grid-cols-12 gap-x-8 gap-y-8">
              
              {/* Row 1: Common Inputs */}
              <div className="col-span-4">
                <label className="block text-xs font-bold text-slate-500 mb-2.5">사용자 그룹 선택</label>
                <div className="relative">
                  {/* ✅ 수정됨: name="macroType", value={formData.macroType} */}
                  <select name="macroType" value={formData.macroType} onChange={handleInputChange} className="w-full p-3 pl-4 bg-white border border-slate-200 rounded-lg text-sm font-bold text-slate-700 focus:ring-2 focus:ring-blue-500 outline-none appearance-none cursor-pointer shadow-sm">
                    {MACRO_CATEGORIES.filter(c => c.id !== 'ALL').map(cat => (
                      <option key={cat.id} value={cat.id}>{cat.label}</option>
                    ))}
                  </select>
                  <div className="absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none text-slate-400"><Settings size={14} /></div>
                </div>
              </div>

              <div className="col-span-8">
                <label className="block text-xs font-bold text-slate-500 mb-2.5">매크로 명칭</label>
                {/* ✅ 수정됨: name="macroName", value={formData.macroName} */}
                <input type="text" name="macroName" value={formData.macroName} onChange={handleInputChange} placeholder="매크로 이름을 입력하세요" className="w-full p-3 bg-slate-50 border border-slate-200 rounded-lg text-sm font-medium focus:bg-white focus:ring-2 focus:ring-blue-500 outline-none transition-all placeholder:text-slate-400" />
              </div>

              {formData.macroType === 'DOCTOR' ? (
                // 1. DOCTOR Layout
                <>
                  <div className="col-span-7 flex flex-col h-full">
                    <label className="block text-xs font-bold text-slate-500 mb-2.5">기본 오더 멘트 (진료 기록용)</label>
                    <textarea name="macroContent" value={formData.macroContent} onChange={handleInputChange} className="w-full min-h-[500px] flex-1 p-6 bg-white border border-slate-200 rounded-2xl text-sm leading-7 text-slate-700 resize-none focus:ring-2 focus:ring-blue-500 outline-none shadow-sm" placeholder="123123123"></textarea>
                  </div>
                  <div className="col-span-5 flex flex-col gap-5">
                    <div className="border border-slate-200 rounded-2xl p-5 bg-white shadow-[0_2px_8px_rgba(0,0,0,0.02)]">
                      <div className="flex justify-between items-center mb-4">
                        <span className="text-xs font-bold text-slate-700">상병코드</span>
                        <button className="text-[11px] text-blue-600 font-bold hover:underline">+ 검색</button>
                      </div>
                      <div className="h-20 bg-slate-50 rounded-xl flex items-center justify-center border-2 border-dashed border-slate-200">
                        <span className="text-[11px] font-medium text-slate-400">등록된 상병이 없습니다.</span>
                      </div>
                    </div>
                    <div className="border border-slate-200 rounded-2xl p-5 bg-white shadow-[0_2px_8px_rgba(0,0,0,0.02)]">
                      <div className="flex justify-between items-center mb-4">
                        <span className="text-xs font-bold text-slate-700">약제 처방</span>
                        <button className="text-[11px] text-blue-600 font-bold hover:underline">+ 추가</button>
                      </div>
                      <div className="h-32 bg-slate-50 rounded-xl flex items-center justify-center border-2 border-dashed border-slate-200">
                        <span className="text-[11px] font-medium text-slate-400">등록된 약제가 없습니다.</span>
                      </div>
                    </div>
                    <div className="grid grid-cols-2 gap-4">
                      <button className="border border-slate-200 rounded-2xl p-4 bg-white shadow-[0_2px_8px_rgba(0,0,0,0.02)] h-36 flex flex-col items-center justify-center gap-2 hover:border-blue-400 hover:bg-blue-50/50 transition-all group">
                          <span className="text-xs font-bold text-slate-600 group-hover:text-blue-700">치료</span>
                          <span className="text-[10px] font-bold text-slate-400 group-hover:text-blue-500">+ 항목 추가</span>
                      </button>
                      <button className="border border-slate-200 rounded-2xl p-4 bg-white shadow-[0_2px_8px_rgba(0,0,0,0.02)] h-36 flex flex-col items-center justify-center gap-2 hover:border-blue-400 hover:bg-blue-50/50 transition-all group">
                          <span className="text-xs font-bold text-slate-600 group-hover:text-blue-700">검사</span>
                          <span className="text-[10px] font-bold text-slate-400 group-hover:text-blue-500">+ 항목 추가</span>
                      </button>
                    </div>
                  </div>
                </>
              ) : (
                <div className="col-span-12 flex flex-col h-full">
                  <label className="block text-xs font-bold text-slate-500 mb-2.5">
                    {getContentLabel(formData.macroType)}
                  </label>
                  <textarea 
                    name="macroContent" 
                    value={formData.macroContent} 
                    onChange={handleInputChange} 
                    className="w-full min-h-[600px] flex-1 p-6 bg-white border border-slate-200 rounded-2xl text-sm leading-7 text-slate-700 resize-none focus:ring-2 focus:ring-blue-500 outline-none shadow-sm" 
                    placeholder="내용을 입력하세요..."
                  ></textarea>
                </div>
              )}

            </div>
          </div>
        </main>
      </div>
    </div>
  );
}